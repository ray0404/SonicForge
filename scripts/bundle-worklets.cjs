
const fs = require('fs');
const path = require('path');

const WORKLETS_DIR = path.join(__dirname, '../src/audio/worklets');
const LIB_DIR = path.join(WORKLETS_DIR, 'lib');
const OUTPUT_FILE = path.join(WORKLETS_DIR, '../worklet-registry.ts');

function bundleWorklets() {
    console.log('Bundling worklets...');

    // Read all lib files
    const libFiles = {};
    if (fs.existsSync(LIB_DIR)) {
        fs.readdirSync(LIB_DIR).forEach(file => {
            if (file.endsWith('.js') && !file.endsWith('.test.js')) {
                libFiles[file] = fs.readFileSync(path.join(LIB_DIR, file), 'utf8');
            }
        });
    }

    const files = fs.readdirSync(WORKLETS_DIR);
    const processorFiles = files.filter(f => f.endsWith('-processor.js'));

    const workletSources = {};

    processorFiles.forEach(file => {
        const filePath = path.join(WORKLETS_DIR, file);
        let content = fs.readFileSync(filePath, 'utf8');

        // Loop to handle recursive/nested imports
        let hasChanges = true;
        let loops = 0;

        while (hasChanges && loops < 10) {
            hasChanges = false;
            loops++;

            // Regex to find imports from ./lib/ or ./dsp-helpers.js relative to wherever it is?
            // Since we inline, the relative paths in the "lib" file (like ./dsp-helpers.js inside crossover.js)
            // match the structure relative to the lib file.
            // In crossover.js: import ... from './dsp-helpers.js'
            // In processor.js: import ... from './lib/crossover.js'

            // So we need to match both './lib/...' AND './...' if it refers to a lib file.
            // But be careful not to match random local imports that don't exist.

            // Strategy: Search for any import ending in .js and check if it matches a known lib file.

            const importRegex = /import\s+.*?\s+from\s+['"](.*?)['"];?/g;

            content = content.replace(importRegex, (match, importPath) => {
                // Determine filename from path
                const filename = path.basename(importPath);

                if (libFiles[filename]) {
                    // It is a known lib file.
                    // Check if we should inline it.
                    // For './lib/crossover.js' -> yes
                    // For './dsp-helpers.js' (inside crossover code) -> yes

                    console.log(`  Bundling ${filename} into ${file} (pass ${loops})`);
                    hasChanges = true;
                    return `// Inlined ${filename}\n${libFiles[filename]}\n`;
                }

                return match;
            });
        }

        // Remove other potential local imports if any (warning)
        if (/import\s+.*?from\s+['"]\./.test(content)) {
            console.warn(`  Warning: ${file} might have other unresolved imports.`);
        }

        workletSources[file] = content;
    });

    // Generate TS file
    const outputContent = `// Auto-generated by scripts/bundle-worklets.js
export const workletSources: Record<string, string> = ${JSON.stringify(workletSources, null, 2)};
`;

    fs.writeFileSync(OUTPUT_FILE, outputContent);
    console.log(`Generated ${OUTPUT_FILE} with ${Object.keys(workletSources).length} worklets.`);
}

bundleWorklets();
